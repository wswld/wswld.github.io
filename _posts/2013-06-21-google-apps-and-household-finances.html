---
layout: post
title: Google Apps and Household Finances
date: 2013-06-21 01:41:06.000000000 +04:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- DIY
- Google
- household finances
- JavaScript
- software
- technology
meta:
  _edit_last: '10080708'
  _publicize_pending: '1'
  _wp_old_slug: google-script-and-household-finances
  geo_public: '0'
  _oxford-post-cache: a:1:{s:15:"featured-images";a:0:{}}
author:
  login: wswld
  email: seva17@gmail.com
  display_name: wswld
  first_name: ''
  last_name: ''
---
<p>I'm in charge of household finances. By this I imply recording every single money transaction, occurring within our family, and providing on demand information about balance by account, overall household value, etc. I also issue monthly financial reports, so that me and my wife could analyze them and come up with a better spending strategy. When the whole thing works, it provides some outstanding insights into the economic condition of our household. <em>When it works</em>.</p>
<p>Let’s assume you want to try it for yourself. Casual Google search will expose you to the vast amount of options, some of them are paid, some — free as in beer. But I dare you wouldn’t be <em>completely</em> satisfied with any of those apps and services:</p>
<ol>
<li>Some of the superb options out there are probably unavailable in your country, if you live outside of US. For example, the famous <a href="https://www.mint.com">Mint</a> app is unavailable in my country without a good VPN.</li>
<li>Some of the projects don’t provide any mobile app or provide a 3rd party solution, which will have all sorts of quirks and unsupported features.</li>
<li>Only a small subset of projects gets it right. Experience is always to some extent limiting even with the paid applications. I’ve never seen a personal finance app that would provide all the features I need, and I’m not among the most demanding users out there, believe me.</li>
<li>You usually have no access to data except for export (if you're lucky). If your data is somehow lost or ruined, it all happens under-the-hood. You won’t be able to fix the thing yourself, unless you’re a developer and the app is open source.</li>
<li>Platforms may be also the thing. Some developers provide only iOS and Mac binding and other try to please everyone except Apple users. I’m using Mac and iPhone, and my wife has been a die hard Android zealot (<em>just kidding</em>). Since she couldn't access our database herself, she notified me about every transaction and I placed it into the system on her behalf. Can you imagine how exhausted I was after several months of this workflow? It was all because the app developer didn’t provide any sane way of syncing between Android and iOS. Moreover, when my wife has switched to the iPhone, we discovered that they don’t even provide syncing between iOS devices.</li>
</ol>
<p>I’m speaking now about <a href="http://www.jumsoft.com/money/">Money by Jumsoft</a>. Not only it never really implemented syncing between different mobile devices, but it also failed to provide simple Mac to iPhone sync, the feature that is actually listed on their site. It used to sync through iCloud but when all the drama with iCloud not supporting databases occurred, they went back to Wi-Fi syncing. It never worked right and ultimately it crippled our data. Five months of carefully collected entries for every single transaction gone in a second. It was the moment I started to look for some other approach.</p>
<p>New approach came as an idea of using something simple and omnipresent. Something that would be available for all of the popular mobile and desktop platforms out there. I was thinking of using Google Docs. First, this idea seemed a little bit crazy (<em>it still does</em>), but then as it developed into a working prototype, it was actually a very smart move (<em>still crazy though</em>). Let’s break the concept down in theory:</p>
<ul>
<li>We need some kind of <strong>interface</strong> for creating entries.</li>
<li>We need a <strong>database</strong> for storing entries.</li>
<li>We need some kind of a <strong>script</strong> to process the results.</li>
</ul>
<p>I looked closely at all the products provided by Google, and found all three components for implementing this concept:</p>
<ul>
<li>Interface is going to be implemented as <a href="http://support.google.com/drive/bin/answer.py?hl=en&amp;amp;answer=87809">Google Forms</a> document.</li>
<li>Database is best implemented as Google Spreadsheet. Jumping ahead of myself, I can also reveal that the forms may write responses to the spreadsheets. That’s exactly what we need!</li>
<li>Script was a little bit harder to figure out. First, I was hoping to process everything with built-in spreadsheet functions, but it never really worked for this kind of calculations. So I went with <a href="https://developers.google.com/apps-script/">Google Apps Script</a>. More of that in a bit.</li>
</ul>
<p>It all look quite simple in theory, but in reality there are quite a few pitfalls here and there. I’m going to guide you trough all the major steps of implementing this concept in practice.</p>
<p>Creating the form and collecting responses is not actually that hard. In Google Drive create the form document and populate it with elements. However, there are a couple of minor considerations which may affect your output data to some extent:</p>
<ol>
<li>Watch the question titles as they directly affect the number of columns and their caps. Section caption is of no interest in regard to the output data though.</li>
<li>Questions do not override. So, if you have question called <em>Amount</em> in one section and a question with the same name in another, it will result in two columns <em>Amount</em> in your table with different values.</li>
<li>Also you may want to avoid nested sections as they complicate things a little.</li>
</ol>
<p>Here is an example of how you should <strong>not</strong> organize your form:</p>
<p>[code language="text"]</p>
<p>Section: Start<br />
Element: Type [Bills, Food]</p>
<p>* Depending on type value go to one of the following:</p>
<p>- Section: Bills<br />
Element: Subtype [Electricity, Cellular, Rent]<br />
Amount: [Number]</p>
<p>* Commit results.</p>
<p>- Section: Food<br />
Element: Subtype [Grocery, Fast Food]<br />
Amount: [Number]</p>
<p>* Commit results.</p>
<p>[/code]</p>
<p>Above you could probably notice an attempt to override the <tt>Subtype</tt> and <tt>Amount</tt> elements. It will result in a table with duplicate <em>Subtype</em> and <em>Amount</em> columns. It’s not that smart but it is the way it is. What I did is getting rid of subtypes and creating only the number of types I would certainly need. For example I have no <em>Bills</em> in types, but <em>Electricity</em>, <em>Cellular</em>, etc. So, I ended up with only one section like this:</p>
<p>[code language="text"]</p>
<p>Section: Start<br />
Element: Type [Electricity, Cellular, Rent, Grocery, Fast Food]<br />
Amount: [Number]<br />
* Commit results.</p>
<p>[/code]</p>
<p>I was geared towards creating the system as simple as possible, so I tried to exclude all the nice but potentially useless stuff leaving only the core functionality, that would be harder to break. In menu go <tt>Responses</tt> → <tt>Choose response destination</tt>. It will show a dialog window allowing you to choose a spreadsheet for your output data. Quite easy. If you test the form now you can see how the responses are being added to the table in your Google Drive. It even creates the human-readable timestamp column, which saves you the trouble of inputing the date and time yourself. Note, that <em>live</em> form may be accessed as a bookmark, or opened in mobile Google Drive apps for Android and iOS.</p>
<p>Creating the form and gathering the data aren’t exactly the trickiest stages of our little project. Providing somehow valuable analytics on top of that data – that’s the real challenge. Let’s imagine, that we’ve collected all the data and now we want to analyze it. We’ll need some automatically updated metrics for our project:</p>
<ol>
<li>Household Balance</li>
<li>Balance by Account</li>
</ol>
<p>As soon as we figure out the algorithm for these two, we can easily implement any other metric (<em>Balance by Category?</em>) using the same method. Note that built-in spreadsheet functions probably won't work, we need something much more extensive and smart. Here comes the <a href="https://developers.google.com/apps-script/">Google Apps Script</a>. It’s basically a full-featured scripting API for simple JavaScript web apps. Google provides the server and the ability to bind the script with the variety of Google Products. If you haven’t heard of that before, there are lots of examples and learning materials on their site — believe me, there is a lot of magic going on over there.</p>
<p>Let’s see how we can apply the scripting capabilities of Google Apps to our case. Open your destination spreadsheet and in menu go: <tt>Tools</tt> → <tt>Script Editor</tt>, in the <tt>Google Apps Script</tt> dialog window select <tt>Spreadsheet</tt> We will need a little script, that should run, when the spreadsheet is opened. Example script will leave you with <code>onOpen</code> and <code>readRows</code> functions. You can pretty much start with that. Let’s see my take on the latter:</p>
<ol>
<li>In the first part we start with <code>SpreadsheetApp.getActiveSpreadsheet()</code> and end with row values as a 2-dimensional array <code>values</code>. Please keep in mind, that the array is 2-dimensional.<br />
[code language="javascript"]</p>
<p>    var ss = SpreadsheetApp.getActiveSpreadsheet();<br />
    var sheet = ss.getSheetByName(&quot;Form Responses&quot;);<br />
    var rows = sheet.getDataRange();<br />
    var numRows = rows.getNumRows();<br />
    var values = rows.getValues();<br />
[/code]</li>
<li>Now we should declare all the variables we will need. In my case it was the output array and a separate variable for every account within family, including the cash accounts:<br />
[code language="javascript"]</p>
<p>    var arr = [];<br />
    var hhld = 0.0;<br />
    var vcsh = 0.0;<br />
    var c4545 = 0.0;<br />
[/code]</p>
<p>Note that <tt>hhld</tt> here stands for the total household value, <tt>vcsh</tt> for Victor's cash, and <tt>c4545</tt> — a fictional credit card by its last four digits.</li>
<li>Let’s iterate trough every row and match the entry with the account accordingly:<br />
[code language="javascript"]</p>
<p>      for (var i = 0; i &lt;= numRows - 1; i++) {<br />
          var row = values[i];</p>
<p>          if (row[1]=='Victor Cash')<br />
          {<br />
              vcsh = vcsh+parseFloat(row[3]);<br />
              hhld = hhld+parseFloat(row[3]);<br />
          }</p>
<p>          if (row[1]=='4545')<br />
          {<br />
              c4545 = c4545+parseFloat(row[3]);<br />
              hhld = hhld+parseFloat(row[3]);<br />
          }<br />
      };<br />
[/code]</li>
<li>Now we may append the values to the array and return it:<br />
[code language="javascript"]</p>
<p>      arr[0]=hhld;<br />
      arr[2]=vcsh;<br />
      arr[3]=c4545;</p>
<p>      return arr;<br />
[/code]</li>
</ol>
<p>Let’s get to the main <tt>onOpen()</tt> function. It is shorter, but a little more tricky:</p>
<ol>
<li>We open an active spreadsheet again, but this time use the other sheet, since no one would ever consider mixing data and results a good idea. We also should create two arrays.<br />
[code language="javascript"]</p>
<p>      var ss = SpreadsheetApp.getActiveSpreadsheet();<br />
      var targetSheet = ss.getSheetByName(&quot;Analytics&quot;);<br />
      var array = [];<br />
      var data = [];<br />
[/code]</li>
<li>Now let’s call the <tt>readRows</tt> function and get an array of account balances. Note how we use <tt>data[0]</tt> to create a two-dimensional array.<br />
[code language="javascript"]</p>
<p>      array = readRows();<br />
      data[0]=array;<br />
[/code]</li>
<li>Finally, we should get the sheet range and assign data to it. Note that <tt>setValues</tt> can work only with 2-dimensional arrays and it was the reason we created one in the first place:<br />
[code language="javascript"]</p>
<p>      var range = targetSheet.getRange('A2:M2');<br />
      range.setValues(data);<br />
[/code]</li>
</ol>
<p>You can test your app by both opening the spreadsheet or calling the <tt>onOpen</tt> function directly by clicking <tt>Tools</tt> → <tt>Script Manager</tt> → <tt>Run</tt>. For now the script doesn’t really work with mobile devices, so you will need to open the sheet on your machine to update the metrics. There are innumerable ways you may improve this script. Please let me know if you come up with something cool.</p>
<p><strong>Update 18.06.2013:</strong> I've found a way to automate the account counters and therefore enable full support for mobile devices. If you follow the workflow described in the post, you would end up with the script running only when opened, however for a spreadsheet paired with a form there is another kind of trigger available: <em>on form sent</em>. It runs the script every time, when the form is sent and unlike <tt>onOpen</tt> it seem to be performed on the side of Google, which makes our script platform-agnostic. Trigger can be enabled by going to <tt>Resources</tt> → <tt>Current project's triggers</tt>. In the dialog window add a new trigger and then select your main function (<tt>onOpen</tt>), next — <tt>From spreadsheet</tt> (yes, they have time-driven triggers too) and <tt>On form submit</tt>. You may test it now by filling the form from your phone and then checking the account counters in a second or so.</p>
<p><b>Update 14.11.2014</b>: We've spent some time with this system (a year or so), but eventually I've decided to make something more reliable: check out my <a href="https://github.com/wswld/menage">Le Ménage</a> project on Github.</p>
